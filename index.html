<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPTV Player</title>
    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.2/dist/hls.min.js"></script>
    <style>
        :root {
            /* Hotstar / Modern TV Palette */
            --bg-color: #0c0e12;
            --sidebar-bg: #13161c;
            --text-primary: #e1e6f0;
            --text-secondary: #9aa4b7;
            --accent-color: #007aff;
            /* Or Gold: #FFD700 if preferred, but Hotstar/Disney is often Blue/White */
            --highlight-color: #ffffff;
            --focus-border: 4px solid var(--highlight-color);
            --focus-shadow: 0 0 20px rgba(0, 0, 0, 0.5);

            --sidebar-width: 320px;
            --card-radius: 12px;
            --transition-speed: 0.25s;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            user-select: none;
            /* Overscan Rule: Safe Area */
            box-sizing: border-box;
            padding: 2vmin;
        }

        /* --- Magic Remote Rule: Simple & Clean Focus --- */
        .focused {
            outline: 3px solid #fff !important;
            /* Clean White */
            background-color: rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5) !important;
            transform: scale(1.05);
            z-index: 999;
            border-color: transparent !important;
        }

        /* Profile Card Specifics to fix visually broken focus */
        .profile-card {
            /* ... existing styles ... */
            border: 2px solid transparent;
        }

        .profile-card.focused {
            border-radius: var(--card-radius);
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- Views Container --- */
        #views-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .view-section {
            display: none;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.4s ease-out;
        }

        .view-section.active {
            display: flex;
        }

        /* --- Profile Screen --- */
        #profile-screen {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #1b2028 0%, #0c0e12 100%);
            z-index: 50;
        }

        .profile-title {
            font-size: 3vw;
            font-weight: 500;
            margin-bottom: 60px;
            color: var(--text-primary);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .profile-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 50px;
            justify-content: center;
            perspective: 1000px;
        }

        .profile-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 12vw;
            min-width: 160px;
            position: relative;
            cursor: pointer;
        }

        .profile-avatar {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, #1f2530 0%, #13161c 100%);
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed);
            border: 3px solid transparent;
            position: relative;
        }

        .profile-text-initial {
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            -webkit-background-clip: text;
            background-clip: text;
            /* Fix lint */
        }

        .profile-name {
            font-size: 1.4rem;
            color: var(--text-secondary);
            font-weight: 400;
            transition: color 0.2s;
            text-align: center;
        }

        /* Profile Colors */
        .color-1 {
            background: linear-gradient(135deg, #ff4b1f, #ff9068);
        }

        .color-2 {
            background: linear-gradient(135deg, #1fa2ff, #12d8fa, #a6ffcb);
        }

        .color-3 {
            background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
        }

        .color-4 {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }

        /* Focus States (Profile) */
        .profile-card.focused.action-select .profile-avatar {
            transform: scale(1.1) translateY(-10px);
            border-color: var(--highlight-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
        }

        .profile-card.focused.action-select .profile-name {
            color: var(--highlight-color);
            font-weight: 600;
        }

        /* Delete Button (WebOS Style) */
        .delete-btn-wrapper {
            margin-top: 15px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .delete-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
        }

        .profile-card.focused .delete-btn-wrapper {
            opacity: 0.4;
            /* Hint it exists */
            transform: translateY(0);
        }

        .profile-card.action-delete .delete-btn-wrapper {
            opacity: 1;
        }

        .profile-card.action-delete .delete-btn {
            background: #ff3b30;
            /* Critical Red */
            border-color: white;
            box-shadow: 0 5px 15px rgba(255, 59, 48, 0.4);
            transform: scale(1.2);
        }

        .profile-card.action-delete .profile-avatar {
            opacity: 0.6;
            transform: scale(1.0);
        }

        .add-profile-icon {
            font-size: 4rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .profile-card.focused .add-profile-icon {
            color: white;
        }


        /* --- Add Playlist Form --- */
        #add-playlist-screen {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #0c0e12;
        }

        .form-container {
            width: 550px;
            padding: 50px;
            background: #191d26;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: scaleIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .form-title {
            font-size: 2rem;
            margin: 0 0 30px 0;
            color: white;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input {
            width: 100%;
            padding: 18px;
            border-radius: 10px;
            border: 2px solid transparent;
            background: #0c0e12;
            color: white;
            font-size: 1.1rem;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: #13161c;
        }

        .btn-row {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .action-btn.focused {
            transform: scale(1.03);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.2);
            z-index: 2;
        }


        /* --- Main App Layout --- */
        #app {
            display: flex;
            height: 100%;
            width: 100%;
            background: var(--bg-color);
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 30px 0;
            z-index: 10;
            box-shadow: 5px 0 30px rgba(0, 0, 0, 0.2);
        }

        #sidebar-header {
            padding: 0 30px 30px 30px;
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(90deg, #fff, #999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            /* More padding for focus rings */
        }

        .category-item {
            padding: 16px 20px;
            font-size: 1rem;
            color: var(--text-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
            /* More space between items */
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            border: 2px solid transparent;
        }

        /* WebOS/Hotstar active state */
        .category-item.active {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .category-item.focused {
            background: white;
            color: black;
            transform: scale(1.02);
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        #sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 10px;
        }

        .footer-btn {
            padding: 15px;
            border-radius: 10px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .footer-btn.focused {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
            border: 2px solid #ff3b30;
        }

        /* Main Content */
        #main-content {
            flex: 1;
            padding: 0;
            /* Let grid control padding */
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
        }

        #header-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 40px 40px 0 40px;
            /* Header padding */
        }

        #category-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            margin: 0;
            line-height: 1;
        }

        #clock-display {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        #grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            /* Generous padding for Safe Area + Focus */
            margin: 0;
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 30px;
            padding-bottom: 50px;
        }

        .channel-card {
            background-color: #191d26;
            border-radius: var(--card-radius);
            aspect-ratio: 16/9;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.3, 0, 0, 1), box-shadow 0.2s;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .channel-card-inner {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .channel-card img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95) 10%, rgba(0, 0, 0, 0.6) 50%, transparent 100%);
            padding: 40px 15px 15px 15px;
            transform: translateY(0);
            /* Always visible */
            transition: opacity 0.3s;
        }

        .channel-card.focused .card-overlay {
            transform: translateY(0);
        }

        .channel-name {
            color: #eee;
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px black;
        }

        .channel-card.focused {
            transform: scale(1.08);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            border: 3px solid white;
            z-index: 5;
        }

        /* Search Box in Header */
        #search-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            /* Very subtle */
            border-radius: 50px;
            /* Pill shape */
            padding: 8px 20px;
            margin-right: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 250px;
            transition: all 0.3s ease;
        }

        #search-container.focused,
        #search-container:focus-within {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            width: 280px;
            /* Slight expansion on focus */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }

        #search-input {
            background: transparent;
            border: none;
            color: #eee;
            font-size: 0.95rem;
            width: 100%;
            margin-left: 10px;
            font-family: inherit;
        }

        #search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        #search-input:focus {
            outline: none;
        }


        /* --- Schedule Panel (Right Side) --- */
        #schedule-panel {
            width: 0;
            background: rgba(12, 14, 18, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        #schedule-panel.open {
            width: 350px;
        }

        .schedule-header {
            padding: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .schedule-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .schedule-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .program-list {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .program-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid transparent;
        }

        .program-item.current {
            background: rgba(255, 255, 255, 0.08);
            border-left-color: var(--accent-color);
        }

        .program-time {
            font-size: 0.85rem;
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .program-name {
            font-size: 1rem;
            color: white;
            font-weight: 500;
        }

        .program-desc {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
            line-height: 1.4;
        }

        /* --- Player Styling --- */
        #player-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 100;
            display: none;
            /* Toggled to flex via JS/CSS */
            justify-content: center;
            /* Center horizontally */
            align-items: center;
            /* Center vertically */
        }

        #video-player {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            /* Preserves aspect ratio, fits within screen */
            outline: none;
        }

        /* Player Controls UI */
        .player-osd {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), transparent);
            padding: 40px 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }

        /* Close Button (X mark) */
        #player-close-btn {
            position: absolute;
            top: 40px;
            right: 40px;
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: auto;
            text-shadow: 0 2px 10px black;
        }

        #player-overlay:hover #player-close-btn,
        #player-overlay:hover .player-osd {
            opacity: 1;
        }

        .show-osd .player-osd {
            opacity: 1;
        }

        .player-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .player-channel-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .player-program-info {
            font-size: 1.2rem;
            color: #ccc;
        }

        .player-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 20px;
            border-radius: 2px;
            position: relative;
        }

        .player-progress-fill {
            height: 100%;
            background: var(--accent-color);
            width: 100%;
            /* Live stream implies full */
            box-shadow: 0 0 10px var(--accent-color);
        }

        .live-tag {
            background: #ff3b30;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 15px;
            vertical-align: middle;
        }

        /* Error/Loading */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 20, 20, 0.9);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #333;
        }
    </style>
</head>

<body>

    <div id="views-container">

        <!-- Profile Selection Screen -->
        <div id="profile-screen" class="view-section">
            <div class="profile-title">Who's watching?</div>
            <!-- Profile Grid -->
            <div class="profile-grid" id="profile-grid">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- Add Playlist Screen -->
        <div id="add-playlist-screen" class="view-section">
            <div class="form-container">
                <h2 class="form-title">Add Playlist</h2>
                <div class="form-group">
                    <label class="form-label">Profile Name</label>
                    <input type="text" id="playlist-name" placeholder="e.g. Bedroom TV" />
                </div>
                <div class="form-group">
                    <label class="form-label">M3U Playlist URL</label>
                    <input type="url" id="playlist-url" value="https://iptv-org.github.io/iptv/languages/tel.m3u" />
                </div>
                <div class="btn-row">
                    <button id="save-playlist-btn" class="action-btn btn-primary">Add Profile</button>
                    <button id="cancel-playlist-btn" class="action-btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Main Player App -->
        <div id="app" class="view-section">
            <!-- Sidebar -->
            <div id="sidebar">
                <div id="sidebar-header">StreamTV</div>
                <div class="sidebar-scroll" id="category-list">
                    <!-- Categories -->
                </div>
                <div id="sidebar-footer">
                    <div id="switch-playlist-btn" class="footer-btn">
                        <span>‚ö°</span> Switch Profile
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div id="main-content">
                <div id="header-area">
                    <h1 id="category-title">All Channels</h1>
                    <div style="display:flex; align-items:center;">
                        <div id="search-container">
                            <span style="font-size:1.2rem;">üîç</span>
                            <input type="text" id="search-input" inputmode="search" placeholder="Search Channels..." />
                        </div>
                        <div id="clock-display">12:00 PM</div>
                    </div>
                </div>

                <div id="grid-container">
                    <div id="channel-grid" class="channel-grid">
                        <!-- Channels -->
                    </div>
                </div>
            </div>

            <!-- Schedule info (Placeholder) -->
            <div id="schedule-panel">
                <div class="schedule-header">
                    <div class="schedule-title">Guide</div>
                    <div class="schedule-subtitle">Today's Schedule</div>
                </div>
                <div class="program-list">
                    <div class="program-item current">
                        <div class="program-time">NOW</div>
                        <div class="program-name">Live Stream</div>
                        <div class="program-desc">No EPG data available for this channel currently.</div>
                    </div>
                    <div class="program-item">
                        <div class="program-time">NEXT</div>
                        <div class="program-name">Upcoming Program</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Video Player -->
    <div id="player-overlay">
        <div id="player-close-btn" onclick="closePlayer()">‚úï</div>
        <video id="video-player"></video>
        <div class="player-osd" id="player-osd">
            <div class="player-info-row">
                <div>
                    <div class="player-channel-title" id="player-channel-name">HBO</div>
                    <div class="player-program-info">Live Stream <span class="live-tag">LIVE</span></div>
                </div>
                <div style="text-align: right; color: #888; font-size: 0.9rem;">
                    720p HD
                </div>
            </div>
            <div class="player-progress-bar">
                <div class="player-progress-fill"></div>
            </div>
        </div>

        <div id="loading-spinner" style="display:none;"></div>
        <div id="error-message" style="display:none;">
            <h3 style="margin: 0 0 10px 0; color: #ff3b30;">Stream Offline</h3>
            <div style="color: #ccc; margin-bottom: 20px;">We couldn't connect to this channel.</div>
            <div style="font-size: 0.8rem; color: #888;">Press BACK to return</div>
        </div>
    </div>

    <script>
        // --- Config & State ---
        const CORS_PROXY = 'https://corsproxy.io/?url=';
        const IMG_PROXY = '//images.weserv.nl/?url=';

        const state = {
            appState: 'profiles', // profiles, add_playlist, browsing, playing

            // Data
            playlists: [],
            currentPlaylist: null,

            channels: [],
            categories: { 'All Channels': [] },
            categoryList: [],

            // Navigation
            profilesIndex: 0,
            profileAction: 'select', // select, delete

            browseView: 'grid', // sidebar, sidebar_footer, grid
            categoryIndex: 0,
            channelIndex: 0,

            // Add Form
            formStep: 0, // 0:Name, 1:Url, 2:Save, 3:Cancel

            // Player
            hls: null,
            playerTimeout: null,

            // Debounce
            debounceTimer: null
        };

        // --- Elements ---
        const dom = {
            views: {
                profiles: document.getElementById('profile-screen'),
                add_playlist: document.getElementById('add-playlist-screen'),
                browsing: document.getElementById('app'),
                playing: document.getElementById('player-overlay') // Logic view
            },
            profileGrid: document.getElementById('profile-grid'),

            catList: document.getElementById('category-list'),
            switchBtn: document.getElementById('switch-playlist-btn'),
            chanGrid: document.getElementById('channel-grid'),
            catTitle: document.getElementById('category-title'),
            clock: document.getElementById('clock-display'),

            searchContainer: document.getElementById('search-container'),
            searchInput: document.getElementById('search-input'),

            inputs: {
                name: document.getElementById('playlist-name'),
                url: document.getElementById('playlist-url'),
                save: document.getElementById('save-playlist-btn'),
                cancel: document.getElementById('cancel-playlist-btn')
            },

            player: {
                overlay: document.getElementById('player-overlay'),
                video: document.getElementById('video-player'),
                osd: document.getElementById('player-osd'),
                title: document.getElementById('player-channel-name'),
                spinner: document.getElementById('loading-spinner'),
                error: document.getElementById('error-message')
            }
        };

        // --- Init ---
        function init() {
            startClock();
            loadPlaylists();

            const lastId = localStorage.getItem('iptv_last_playlist_id');
            let autoAuth = false;

            if (state.playlists.length > 0 && lastId) {
                const idx = state.playlists.findIndex(p => p.id == lastId);
                if (idx !== -1) {
                    autoAuth = true;
                    selectProfile(idx);
                }
            }

            if (!autoAuth) {
                if (state.playlists.length === 0) changeView('add_playlist');
                else {
                    renderProfiles();
                    changeView('profiles');
                }
            }

            setupInput();
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                dom.clock.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }, 1000);
        }

        // --- View Manager ---
        function changeView(newView) {
            state.appState = newView;
            state.profileAction = 'select'; // reset

            // DOM Visibility
            Object.values(dom.views).forEach(el => el.classList.remove('active'));

            if (newView === 'playing') {
                dom.views.browsing.classList.add('active'); // Keep browsing visible behind
                dom.player.overlay.style.display = 'flex';
            } else {
                dom.views[newView].classList.add('active');
                dom.player.overlay.style.display = 'none';
            }

            // Focus Update
            setTimeout(updateFocus, 50);
        }

        // --- Persistence ---
        function loadPlaylists() {
            try {
                state.playlists = JSON.parse(localStorage.getItem('iptv_playlists') || '[]');
            } catch (e) { state.playlists = []; }
        }

        function savePlaylist() {
            const name = dom.inputs.name.value || "My Playlist";
            const url = dom.inputs.url.value;
            if (!url) return alert("URL Required");

            state.playlists.push({
                id: Date.now(),
                name, url,
                color: 'color-' + ((state.playlists.length % 4) + 1)
            });
            localStorage.setItem('iptv_playlists', JSON.stringify(state.playlists));

            renderProfiles();
            changeView('profiles');
        }

        function deletePlaylist(idx) {
            if (!confirm("Remove this profile?")) return;
            state.playlists.splice(idx, 1);
            localStorage.setItem('iptv_playlists', JSON.stringify(state.playlists));

            state.profilesIndex = 0;
            state.profileAction = 'select';

            if (state.playlists.length === 0) changeView('add_playlist');
            else {
                renderProfiles();
                updateFocus();
            }
        }

        // --- Renderers ---
        function renderProfiles() {
            dom.profileGrid.innerHTML = '';
            state.playlists.forEach((pl, i) => {
                const el = document.createElement('div');
                el.className = 'profile-card';
                el.innerHTML = `
                <div class="profile-avatar ${pl.color}">
                    <span class="profile-text-initial">${pl.name[0].toUpperCase()}</span>
                </div>
                <div class="profile-name">${pl.name}</div>
                <div class="delete-btn-wrapper">
                    <div class="delete-btn">‚úï</div>
                </div>
            `;
                el.onclick = () => selectProfile(i);
                el.onmouseover = () => { state.profilesIndex = i; updateFocus(); };
                dom.profileGrid.appendChild(el);
            });

            // Add Btn
            const addEl = document.createElement('div');
            addEl.className = 'profile-card';
            addEl.innerHTML = `
             <div class="profile-avatar add-profile-avatar">
                <div class="add-profile-icon">+</div>
             </div>
             <div class="profile-name">Add Profile</div>
        `;
            addEl.innerHTML = `
             <div class="profile-avatar add-profile-avatar">
                <div class="add-profile-icon">+</div>
             </div>
             <div class="profile-name">Add Profile</div>
        `;
            addEl.className = 'profile-card';
            addEl.onclick = () => {
                dom.inputs.name.value = '';
                // dom.inputs.url.value = ''; // keep default for ease
                state.formStep = 0;
                changeView('add_playlist');
            };
            addEl.onmouseover = () => { state.profilesIndex = state.playlists.length; updateFocus(); };
            dom.profileGrid.appendChild(addEl);
        }

        function renderSidebar() {
            dom.catList.innerHTML = '';
            state.categoryList.forEach((cat, i) => {
                const el = document.createElement('div');
                el.className = 'category-item';
                el.textContent = cat;
                // Visual active state only, actual selection via logic
                if (i === state.categoryIndex) el.classList.add('active');

                el.onclick = () => {
                    selectCategory(i);
                    state.browseView = 'sidebar';
                    updateFocus();
                };
                el.onmouseover = () => {
                    // Sync focus but don't auto-select content yet (wait for click)
                    state.categoryIndex = i;
                    updateFocus();
                };
                dom.catList.appendChild(el);
            });
        }

        // Global Image Error Handler
        function handleImageError(img) {
            const fallbackStep = parseInt(img.dataset.fallbackStep || '0');
            const originalSrc = img.dataset.originalSrc;

            if (fallbackStep === 0) {
                // Step 1: Proxy failed. Try Direct URL.
                img.dataset.fallbackStep = '1';
                if (originalSrc) {
                    img.src = originalSrc;
                } else {
                    showTextFallback(img);
                }
            } else if (fallbackStep === 1) {
                // Step 2: Direct URL failed. Show Text.
                img.dataset.fallbackStep = '2';
                showTextFallback(img);
            }
        }

        function showTextFallback(img) {
            img.style.display = 'none';
            if (img.nextElementSibling && img.nextElementSibling.classList.contains('no-logo')) {
                img.nextElementSibling.style.display = 'block';
            }
        }

        // ... (init and other functions) ...

        function renderGrid(customChannels = null) {
            dom.chanGrid.innerHTML = '';
            const channels = customChannels || state.categories[state.categoryList[state.categoryIndex]];

            if (!channels || channels.length === 0) {
                dom.chanGrid.innerHTML = '<div style="color:#666; padding:20px;">No channels found.</div>';
                return;
            }

            channels.forEach((ch, i) => {
                const el = document.createElement('div');
                el.className = 'channel-card';

                // Image Logic:
                // 1. Try Weserv Proxy (optmized)
                // 2. On Error -> handleImageError -> Try Direct URL
                // 3. On Error -> handleImageError -> Show Text

                let imgHTML = '';
                if (ch.logo) {
                    // Proxy URL
                    const proxyUrl = 'https://images.weserv.nl/?url=' + encodeURIComponent(ch.logo) + '&w=300&output=webp&il';

                    imgHTML = `
            <img src="${proxyUrl}"
                data-original-src="${ch.logo}"
                data-fallback-step="0"
                loading="lazy"
                referrerpolicy="no-referrer"
                crossorigin="anonymous"
                onerror="handleImageError(this)"
            />
            <div class="no-logo" style="display:none; font-size:2rem; color: #555;">TV</div>
            `;
                } else {
                    imgHTML = `<div class="no-logo" style="font-size:2rem; color: #555;">TV</div>`;
                }

                el.innerHTML = `
            <div class="channel-card-inner">${imgHTML}</div>
            <div class="card-overlay">
                <div class="channel-name">${ch.name}</div>
            </div>
                `;
                el.onclick = () => playChannel(ch);
                el.onmouseover = () => {
                    // Switch to grid view if not already (handles transitions from sidebar hover)
                    if (state.browseView !== 'grid') state.browseView = 'grid';
                    state.channelIndex = i;
                    updateFocus();
                };
                dom.chanGrid.appendChild(el);
            });
        }

        // --- Logic ---
        function selectProfile(i) {
            state.currentPlaylist = state.playlists[i];
            localStorage.setItem('iptv_last_playlist_id', state.currentPlaylist.id);

            fetch(state.currentPlaylist.url).then(r => r.text()).then(txt => {
                parseM3U(txt);
                renderSidebar();
                selectCategory(0);
                changeView('browsing');
            }).catch(e => {
                alert("Failed to load playlist");
                state.appState = 'profiles';
                renderProfiles();
                changeView('profiles');
            });
        }

        function parseM3U(raw) {
            const lines = raw.split('\n');
            state.channels = [];
            state.categories = { 'All Channels': [] };
            let curr = {};

            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const info = line.substring(8);
                    const logo = (info.match(/tvg-logo="([^"]*)"/) || [])[1];
                    const group = (info.match(/group-title="([^"]*)"/) || [])[1] || 'Uncategorized';
                    const name = info.split(',').pop().trim();
                    curr = { name, logo, group };
                } else if (line && !line.startsWith('#')) {
                    curr.url = line;
                    if (curr.name && curr.url) {
                        state.channels.push(curr);
                        state.categories['All Channels'].push(curr);
                        if (!state.categories[curr.group]) state.categories[curr.group] = [];
                        state.categories[curr.group].push(curr);
                    }
                    curr = {};
                }
            });

            const keys = Object.keys(state.categories).sort();
            const allIdx = keys.indexOf('All Channels');
            if (allIdx > -1) { keys.splice(allIdx, 1); keys.unshift('All Channels'); }
            state.categoryList = keys;
        }

        // Select category immediately (for click or debounce end)
        function selectCategory(i) {
            if (state.debounceTimer) clearTimeout(state.debounceTimer);

            // Reset Search
            dom.searchInput.value = '';
            state.browseView = 'sidebar'; // Default focus logic

            state.categoryIndex = i;
            const name = state.categoryList[i];
            dom.catTitle.textContent = name;

            // Update Grid
            renderGrid();

            // Update Sidebar visual
            Array.from(dom.catList.children).forEach((c, idx) => c.classList.toggle('active', idx === i));
            state.channelIndex = 0;
        }

        // Updates Sidebar Visuals ONLY (scrolling)
        function highlightCategory(i) {
            state.categoryIndex = i;
            updateFocus(); // Scrolls into view

            // Debounce the Grid Update
            if (state.debounceTimer) clearTimeout(state.debounceTimer);
            state.debounceTimer = setTimeout(() => {
                selectCategory(i);
            }, 300); // 300ms delay
        }


        // --- Input & Navigation ---
        function setupInput() {
            document.addEventListener('keydown', (e) => {
                const k = e.keyCode;
                const router = {
                    13: 'ENTER', 40: 'DOWN', 38: 'UP', 37: 'LEFT', 39: 'RIGHT',
                    461: 'BACK', 10009: 'BACK', 27: 'BACK', 8: 'BACK'
                };
                if (!router[k]) return;

                // SPECIAL HANDLE FOR BACKSPACE IN INPUT
                const isInput = document.activeElement.tagName === 'INPUT';
                if (isInput) {
                    if (k === 8) return; // Allow Backspace to delete text
                    if (k === 27) { e.preventDefault(); handleNav('BACK'); return; } // ESC = Back
                    if (k === 13) { e.preventDefault(); handleNav('ENTER'); return; } // Enter
                    // Allow arrows/typing in input, ignore other nav keys
                    if (k !== 461 && k !== 10009) return;
                }

                // Prevent Default Browser Action for Nav Keys (especially Back)
                e.preventDefault();
                handleNav(router[k]);
            });

            // Search Filter
            dom.searchInput.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                if (!val) {
                    selectCategory(state.categoryIndex);
                    return;
                }
                const filtered = state.categories['All Channels'].filter(c => c.name.toLowerCase().includes(val));
                renderGrid(filtered);
                dom.catTitle.textContent = "Search Results";
                state.channelIndex = 0;
                state.browseView = 'search'; // Stay in search
            });

            // Mouse/Touch Handlers
            dom.inputs.save.onclick = savePlaylist;
            dom.inputs.cancel.onclick = () => changeView('profiles');
            dom.switchBtn.onclick = () => {
                localStorage.removeItem('iptv_last_playlist_id');
                changeView('profiles');
                renderProfiles();
            };
        }

        function updateFocus() {
            // Clear Highlighting
            document.querySelectorAll('.focused').forEach(e => e.classList.remove('focused', 'action-select', 'action-delete'));

            if (state.appState === 'profiles') {
                const items = dom.profileGrid.children;
                const i = Math.min(state.profilesIndex, items.length - 1);
                if (items[i]) {
                    items[i].classList.add('focused', 'action-' + state.profileAction);
                }

            } else if (state.appState === 'add_playlist') {
                const steps = [dom.inputs.name, dom.inputs.url, dom.inputs.save, dom.inputs.cancel];
                if (steps[state.formStep]) {
                    steps[state.formStep].focus();
                    if (state.formStep >= 2) steps[state.formStep].classList.add('focused');
                }

            } else if (state.appState === 'browsing') {
                if (state.browseView === 'search') {
                    // Highlight the container, but don't force focus input yet (wait for Enter)
                    dom.searchContainer.classList.add('focused');
                }
                else if (state.browseView === 'sidebar') {
                    dom.searchInput.blur();
                    const item = dom.catList.children[state.categoryIndex];
                    if (item) {
                        item.classList.add('focused');
                        item.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                } else if (state.browseView === 'sidebar_footer') {
                    dom.switchBtn.classList.add('focused');
                } else { // Grid
                    dom.searchInput.blur();
                    const item = dom.chanGrid.children[state.channelIndex];
                    if (item) {
                        item.classList.add('focused');
                        item.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }
            }
        }

        function handleNav(action) {
            if (state.appState === 'playing') {
                if (action === 'BACK' || action === 'ENTER') closePlayer();
                showOSD();
                return;
            }

            if (action === 'BACK') {
                if (state.appState === 'add_playlist') changeView('profiles');
                else if (state.appState === 'browsing') {
                    if (state.browseView === 'grid') { state.browseView = 'sidebar'; updateFocus(); }
                    else if (state.browseView === 'search') {
                        // Clear Search on back
                        state.browseView = 'sidebar';
                        dom.searchInput.blur();
                        dom.searchInput.value = '';
                        selectCategory(state.categoryIndex);
                    }
                    // Else stay
                }
                return;
            }

            // --- Logic Delegation ---
            if (state.appState === 'profiles') navProfiles(action);
            else if (state.appState === 'add_playlist') navAddForm(action);
            else if (state.appState === 'browsing') navBrowsing(action);
        }

        function navProfiles(action) {
            const len = dom.profileGrid.children.length;
            if (action === 'RIGHT' && state.profilesIndex < len - 1) {
                state.profilesIndex++;
                state.profileAction = 'select';
            }
            if (action === 'LEFT' && state.profilesIndex > 0) {
                state.profilesIndex--;
                state.profileAction = 'select';
            }
            if (action === 'DOWN') {
                // Check if on real profile (not add btn)
                if (state.profilesIndex < state.playlists.length) {
                    state.profileAction = 'delete';
                }
            }
            if (action === 'UP') {
                state.profileAction = 'select';
            }
            if (action === 'ENTER') {
                if (state.profilesIndex === state.playlists.length) {
                    // Add Btn
                    changeView('add_playlist');
                } else {
                    if (state.profileAction === 'delete') deletePlaylist(state.profilesIndex);
                    else selectProfile(state.profilesIndex);
                }
            }
            updateFocus();
        }

        function navAddForm(action) {
            if (action === 'DOWN' && state.formStep < 3) state.formStep++;
            if (action === 'UP' && state.formStep > 0) state.formStep--;
            if (action === 'ENTER') {
                if (state.formStep === 2) savePlaylist();
                else if (state.formStep === 3) changeView('profiles');
            }
            updateFocus();
        }

        function getGridCols() {
            const children = dom.chanGrid.children;
            if (children.length === 0) return 3; // Default

            const firstTop = children[0].offsetTop;
            let cols = 0;
            for (let i = 0; i < children.length; i++) {
                if (children[i].offsetTop === firstTop) cols++;
                else break;
            }
            return cols;
        }

        function navBrowsing(action) {
            // --- SEARCH VIEW ---
            if (state.browseView === 'search') {
                if (action === 'DOWN') {
                    // Go back to content
                    state.browseView = 'grid';
                    state.channelIndex = 0;
                }
                if (action === 'ENTER') {
                    // ACTIVATE KEYBOARD
                    dom.searchInput.focus();
                }
                updateFocus();
                return;
            }

            // --- SIDEBAR ---
            if (state.browseView === 'sidebar') {
                if (action === 'UP') {
                    if (state.categoryIndex > 0) highlightCategory(state.categoryIndex - 1);
                    else {
                        // Go to Search from top of sidebar
                        state.browseView = 'search';
                    }
                }
                if (action === 'DOWN') {
                    if (state.categoryIndex < state.categoryList.length - 1) highlightCategory(state.categoryIndex + 1);
                    else state.browseView = 'sidebar_footer';
                }
                if (action === 'RIGHT' || action === 'ENTER') {
                    selectCategory(state.categoryIndex);
                    state.browseView = 'grid';
                }
            }

            // --- FOOTER ---
            else if (state.browseView === 'sidebar_footer') {
                if (action === 'UP') {
                    state.browseView = 'sidebar';
                    updateFocus();
                }
                if (action === 'RIGHT') {
                    state.browseView = 'grid';
                    selectCategory(state.categoryIndex);
                }
                if (action === 'ENTER') {
                    localStorage.removeItem('iptv_last_playlist_id');
                    changeView('profiles');
                    renderProfiles();
                }
            }

            // --- GRID ---
            else { // Grid
                const cols = getGridCols();
                const max = dom.chanGrid.children.length - 1;

                // Allow going up to search from row 0
                if (action === 'UP') {
                    if (state.channelIndex < cols) {
                        state.browseView = 'search';
                        // Don't change channelIndex so we can go back down
                    } else {
                        state.channelIndex -= cols;
                    }
                }
                else if (action === 'RIGHT' && state.channelIndex < max) state.channelIndex++;
                else if (action === 'LEFT') {
                    if (state.channelIndex % cols === 0) state.browseView = 'sidebar';
                    else state.channelIndex--;
                }
                else if (action === 'DOWN') {
                    if (state.channelIndex + cols <= max) state.channelIndex += cols;
                    else state.channelIndex = max;
                }
                else if (action === 'ENTER') {
                    // If in search mode, use filtered list?
                    // renderGrid already handles rendering the right list.
                    // But we need to know which channel object.
                    // Simplified: We rely on the DOM order matching renderGrid logic?
                    // Actually safer to trust renderGrid's source.
                    // But handleSearch updates DOM.

                    // Better: Check active list source.
                    let channels = state.categories[state.categoryList[state.categoryIndex]];
                    if (dom.searchInput.value) {
                        channels = state.categories['All Channels'].filter(c => c.name.toLowerCase().includes(dom.searchInput.value.toLowerCase()));
                    }

                    if (channels[state.channelIndex]) {
                        playChannel(channels[state.channelIndex]);
                    }
                }
            }
            updateFocus();
        }

        // --- Player Logic ---
        function playChannel(ch) {
            if (!ch || !ch.url) return;

            // Show Player
            changeView('playing');
            dom.player.title.textContent = ch.name;
            dom.player.spinner.style.display = 'block';
            dom.player.error.style.display = 'none';

            if (Hls.isSupported()) {
                if (state.hls) state.hls.destroy();

                // Optimized Config for TV/WebOS
                const config = {
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    maxBufferLength: 30, // conservative for TV memory
                    maxMaxBufferLength: 60,
                    startLevel: -1, // Auto
                };

                state.hls = new Hls(config);
                state.hls.loadSource(ch.url);
                state.hls.attachMedia(dom.player.video);

                state.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    dom.player.video.play().catch(e => console.log("Auto-play prevented", e));
                    dom.player.spinner.style.display = 'none';
                });

                state.hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                state.hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                state.hls.recoverMediaError();
                                break;
                            default:
                                dom.player.spinner.style.display = 'none';
                                dom.player.error.style.display = 'block';
                                break;
                        }
                    }
                });
            } else if (dom.player.video.canPlayType('application/vnd.apple.mpegurl')) {
                dom.player.video.src = ch.url;
                dom.player.video.addEventListener('loadedmetadata', () => {
                    dom.player.video.play();
                    dom.player.spinner.style.display = 'none';
                });
            }
        }

        function closePlayer() {
            if (dom.player.video) {
                dom.player.video.pause();
                dom.player.video.src = "";
            }
            if (state.hls) {
                state.hls.destroy();
                state.hls = null;
            }
            changeView('browsing');
        }

        function showOSD() {
            dom.player.osd.style.opacity = '1';
            if (state.playerTimeout) clearTimeout(state.playerTimeout);
            state.playerTimeout = setTimeout(() => {
                dom.player.osd.style.opacity = '0';
            }, 5000);
        }

        // --- BOOT ---
        window.onload = init;

    </script>